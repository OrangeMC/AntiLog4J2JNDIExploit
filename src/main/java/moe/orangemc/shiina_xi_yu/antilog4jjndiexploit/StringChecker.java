package moe.orangemc.shiina_xi_yu.antilog4jjndiexploit;

import java.util.function.Function;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class StringChecker
{
    static PlatformPlayerHelper PLATFORM;

    interface PlatformPlayerHelper {
        void sendToPlayer(Object player, String msg);
        String getName(Object player);
        void broadcast(String msg);
    }

    static final Pattern regex = Pattern.compile(
            "\\$\\{.*?:.*?}",
            Pattern.CASE_INSENSITIVE |
                    Pattern.MULTILINE |
                    Pattern.DOTALL
    );

    public static String replaceAll(String origin, Matcher matcher, Function<String, String> replacement)
    {
        matcher.reset();
        boolean result = matcher.find();
        if (result)
        {
            StringBuilder sb = new StringBuilder();
            int lastPosition = 0;
            do
            {
                sb.append(origin, lastPosition, matcher.start());
                String replaced = replacement.apply(
                        origin.substring(matcher.start(), lastPosition = matcher.end())
                );
                sb.append(replaced);
                result = matcher.find();
            } while (result);
            sb.append(origin, lastPosition, origin.length());
            return sb.toString();
        }
        return origin;
    }

    public static String replace0(String v, Object player)
    {
        Matcher matcher = regex.matcher(v);
        if (matcher.find() && Config.msg_broadcast_player_packet != null)
        {
            PLATFORM.broadcast(Config.msg_broadcast_player_packet.replace("%Player%", PLATFORM.getName(player)));
            if (Config.sendBackIfExploit)
            {
                PLATFORM.sendToPlayer(player, v);
            }
        }
        return replaceAll(v, matcher, v2 -> v2.replace('{', '[').replace('}', ']'));
    }
}
